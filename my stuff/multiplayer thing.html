    <!-- ... (head and body up to the script tag) ... -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js"; // Added Auth
        import { 
            getDatabase, ref, set, onValue, push, remove,
            serverTimestamp, query, orderByChild, limitToLast, equalTo,
            onDisconnect
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
      
        const firebaseConfig = {
            apiKey: "AIzaSyBLCRiYQuFNywe26ckNPaOay8tm3UHT9vA",
            authDomain: "liqrid.firebaseapp.com",
            projectId: "liqrid",
            storageBucket: "liqrid.appspot.com",
            messagingSenderId: "196493662290",
            appId: "1:196493662290:web:17546d72fed9a06677278b",
            measurementId: "G-0491BG4LP9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app); // Initialize Firebase Auth

        // Global variables
        let canvas, ctx;
        let currentTool = 'brush';
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        
        let localUsername = '';
        let firebaseUser = null; // Will hold the authenticated user object (includes uid)

        let currentRoomId = null;
        let currentRoomData = null; 

        let undoStack = [];
        let redoStack = [];
        let currentPath = [];

        // Firebase listeners (can be used to store unsubscribe functions if needed)
        // let roomsListenerUnsubscribe = null; 
        // let usersListenerUnsubscribe = null;
        // etc.
        
        let sidebarEl, appContainerEl, mainMobileMenuBtnEl, sidebarMobileMenuBtnEl, currentRoomTitleEl;
        let roomNameInputEl, usernameInputEl, isPrivateCheckboxEl;
        let joinUsernameInputEl, joinRoomPasswordInputEl, joinPasswordGroupEl, joinModalTitleEl;
        let authStatusEl; // For displaying auth status

        document.addEventListener('DOMContentLoaded', () => {
            // Create an element to show auth status (optional)
            authStatusEl = document.createElement('div');
            authStatusEl.style.position = 'fixed';
            authStatusEl.style.bottom = '5px';
            authStatusEl.style.left = '5px';
            authStatusEl.style.padding = '5px 10px';
            authStatusEl.style.background = 'rgba(255,255,255,0.1)';
            authStatusEl.style.border = '1px solid white';
            authStatusEl.style.borderRadius = '3px';
            authStatusEl.style.fontSize = '10px';
            authStatusEl.style.zIndex = '2000';
            document.body.appendChild(authStatusEl);

            initApp();
        });

        function initApp() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            cacheDOMElements();
            
            document.getElementById('colorPicker').value = '#000000';

            setupEventListeners(); // Event listeners that don't depend on auth state
            setupCanvasEvents();
            setupMobileSupport();
            saveCanvasState(); 

            lucide.createIcons();
            
            // Listen for auth state changes
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in anonymously.
                    firebaseUser = user; // Store the user object
                    authStatusEl.textContent = `Authenticated (UID: ${user.uid.substring(0,6)}...)`;
                    authStatusEl.style.borderColor = 'lime';

                    // Now that user is authenticated, we can load data that requires auth
                    listenToPublicRooms(); 
                    
                    const savedUsername = localStorage.getItem('canvasChatUsername_v9');
                    if (savedUsername) {
                        usernameInputEl.value = savedUsername;
                        joinUsernameInputEl.value = savedUsername; 
                        localUsername = savedUsername;
                    } else if (usernameInputEl.value) { // If user typed before auth
                        localUsername = usernameInputEl.value.trim();
                        localStorage.setItem('canvasChatUsername_v9', localUsername);
                    }
                    
                    // If was in a room before a page refresh, try to re-join (complex, skip for now)

                } else {
                    // User is signed out.
                    firebaseUser = null;
                    authStatusEl.textContent = 'Authenticating...';
                    authStatusEl.style.borderColor = 'orange';
                    console.log("User is signed out, attempting to sign in anonymously.");
                    signInAnonymously(auth)
                        .catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            authStatusEl.textContent = `Auth FAILED: ${error.code}`;
                            authStatusEl.style.borderColor = 'red';
                            alert("Authentication failed. Please check your Firebase setup and console for errors. The app may not work correctly.");
                        });
                }
            });
        }


        function cacheDOMElements() {
            sidebarEl = document.getElementById('sidebar');
            appContainerEl = document.getElementById('appContainer');
            mainMobileMenuBtnEl = document.getElementById('mainMobileMenuBtn');
            sidebarMobileMenuBtnEl = sidebarEl.querySelector('.mobile-menu-btn');
            currentRoomTitleEl = document.getElementById('currentRoomTitle');
            
            roomNameInputEl = document.getElementById('roomNameInput');
            usernameInputEl = document.getElementById('usernameInput');
            isPrivateCheckboxEl = document.getElementById('isPrivateCheckbox');

            joinUsernameInputEl = document.getElementById('joinUsernameInput');
            joinRoomPasswordInputEl = document.getElementById('joinRoomPasswordInput');
            joinPasswordGroupEl = document.getElementById('joinPasswordGroup');
            joinModalTitleEl = document.getElementById('joinModalTitle');
        }

        function setupEventListeners() {
            // ... (same as before, ensure onclicks call window.funcName or are handled here)
             document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!firebaseUser) { alert("Please wait for authentication."); return; }
                    currentTool = btn.dataset.tool;
                    document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    canvas.style.cursor = currentTool === 'select' ? 'default' : 'crosshair';
                });
            });

            document.getElementById('imageUpload').addEventListener('change', (e) => window.handleImageUpload(e)); // Ensure window scope for event
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    window.sendMessage();
                }
            });

            usernameInputEl.addEventListener('input', (e) => { // Use 'input' for real-time update
                localUsername = e.target.value.trim();
                localStorage.setItem('canvasChatUsername_v9', localUsername);
                joinUsernameInputEl.value = localUsername; 
            });
             joinUsernameInputEl.addEventListener('input', (e) => {
                localUsername = e.target.value.trim();
                localStorage.setItem('canvasChatUsername_v9', localUsername);
                usernameInputEl.value = localUsername; 
            });
        }
        
        function listenToPublicRooms() {
            if (!firebaseUser) return; // Don't listen if not authenticated

            const roomsQuery = query(ref(db, 'rooms'), orderByChild('metadata/isPrivate'), equalTo(false));
            onValue(roomsQuery, snapshot => {
                const roomsData = snapshot.val() || {};
                updateRoomsList(roomsData);
            }, error => {
                console.error("Error fetching public rooms:", error);
                if (error.code === 'PERMISSION_DENIED') {
                    addChatMessage('System', 'Error: Cannot access rooms list. Check Firebase rules.');
                } else {
                    addChatMessage('System', 'Error fetching rooms list.');
                }
            });
        }

        function updateRoomsList(roomsData) {
            // ... (same as before)
            const roomListEl = document.getElementById('roomList');
            roomListEl.innerHTML = ''; 
            const roomIds = Object.keys(roomsData);

            if (roomIds.length === 0) {
                roomListEl.innerHTML = '<p style="color: rgba(255,255,255,0.5); font-style:italic;">No active public rooms.</p>';
                return;
            }

            roomIds.forEach(roomId => {
                const room = roomsData[roomId];
                if (!room.metadata) return; 

                const roomDiv = document.createElement('div');
                roomDiv.className = 'room-item';
                if (roomId === currentRoomId) {
                    roomDiv.classList.add('active');
                }
                const userCount = room.users ? Object.keys(room.users).length : 0;
                roomDiv.innerHTML = `
                    <div class="room-name">${room.metadata.name}</div>
                    <div class="room-info">${userCount} user(s) online</div>
                `;
                roomDiv.addEventListener('click', () => {
                    if (!firebaseUser) { alert("Please wait for authentication to complete."); return; }
                    if (currentRoomId !== roomId) {
                        promptToJoinRoom(roomId, room.metadata);
                    }
                });
                roomListEl.appendChild(roomDiv);
            });
        }
        
        window.createRoom = function() { 
            if (!firebaseUser) { alert("Authentication required to create a room."); return; }

            const roomName = roomNameInputEl.value.trim();
            localUsername = usernameInputEl.value.trim(); 
            const isPrivate = isPrivateCheckboxEl.checked;

            if (!roomName || !localUsername) {
                alert('Please enter room name and your username.');
                return;
            }
            localStorage.setItem('canvasChatUsername_v9', localUsername);

            let password = null;
            if (isPrivate) {
                password = prompt('Enter room password (min 6 chars):');
                if (!password || password.length < 6) {
                    alert('Private rooms require a password of at least 6 characters.');
                    return;
                }
            }
            
            if (currentRoomId) { 
                leaveCurrentRoom();
            }

            const newRoomRef = push(ref(db, 'rooms'));
            const newRoomId = newRoomRef.key;

            const roomMetadata = {
                name: roomName,
                isPrivate: isPrivate,
                creatorUsername: localUsername,
                creatorId: firebaseUser.uid, // Use Firebase Auth UID
                createdAt: serverTimestamp()
            };
            if (isPrivate) {
                roomMetadata.passwordHash = password; 
            }

            const initialCanvasState = canvas.toDataURL();

            set(newRoomRef, {
                metadata: roomMetadata,
                fullCanvasDataUrl: initialCanvasState,
            }).then(() => {
                addChatMessage('System', `Room "${roomName}" created.`);
                actuallyJoinRoom(newRoomId, roomMetadata, password);
            }).catch(error => {
                console.error("Error creating room:", error);
                alert("Error creating room: " + error.message + ". Check Firebase rules and console.");
            });
        }

        let selectedRoomIdToJoin = null;
        let selectedRoomMetadataToJoin = null;

        function promptToJoinRoom(roomId, roomMetadata) {
            if (!firebaseUser) { alert("Authentication required."); return; }
            if (!localUsername) {
                 const userVal = joinUsernameInputEl.value.trim() || usernameInputEl.value.trim();
                 if (!userVal) {
                    alert("Please enter your username in the sidebar or join dialog first.");
                    joinUsernameInputEl.focus();
                    return;
                 }
                 localUsername = userVal;
                 localStorage.setItem('canvasChatUsername_v9', localUsername);
            } else {
                 joinUsernameInputEl.value = localUsername; 
            }

            selectedRoomIdToJoin = roomId; 
            selectedRoomMetadataToJoin = roomMetadata;

            joinModalTitleEl.textContent = `Join Room: ${roomMetadata.name}`;
            joinPasswordGroupEl.style.display = roomMetadata.isPrivate ? 'block' : 'none';
            joinRoomPasswordInputEl.value = '';
            document.getElementById('joinModal').classList.remove('hidden');
        }
        
        window.confirmJoinRoom = function() { 
            if (!firebaseUser) { alert("Authentication required."); return; }
            const password = joinRoomPasswordInputEl.value;
            localUsername = joinUsernameInputEl.value.trim(); 
             if (!localUsername) {
                alert("Please enter your username.");
                return;
            }
            localStorage.setItem('canvasChatUsername_v9', localUsername);

            if (selectedRoomMetadataToJoin.isPrivate) {
                onValue(ref(db, `rooms/${selectedRoomIdToJoin}/metadata/passwordHash`), (snapshot) => {
                    const correctPassword = snapshot.val();
                    if (password !== correctPassword) {
                        alert('Incorrect password.');
                        return;
                    }
                    if (currentRoomId) leaveCurrentRoom();
                    actuallyJoinRoom(selectedRoomIdToJoin, selectedRoomMetadataToJoin, password);
                }, { onlyOnce: true }); 
            } else {
                if (currentRoomId) leaveCurrentRoom();
                actuallyJoinRoom(selectedRoomIdToJoin, selectedRoomMetadataToJoin);
            }
        }

        function actuallyJoinRoom(roomId, roomMeta, roomPasswordAttempt) {
            if (!firebaseUser) { console.error("Cannot join room: not authenticated."); return; }
            currentRoomId = roomId;
            currentRoomData = roomMeta; 

            const userRefPath = `rooms/${currentRoomId}/users/${firebaseUser.uid}`; // Use Firebase Auth UID
            const userPresenceRef = ref(db, userRefPath);

            set(userPresenceRef, localUsername).then(() => {
                const disconnectHandler = onDisconnect(userPresenceRef);
                disconnectHandler.remove(); 
                
                currentRoomTitleEl.textContent = currentRoomData.name;
                closeModal();
                if (sidebarEl.classList.contains('open') && window.innerWidth <= 768) {
                    toggleSidebar();
                }
                addChatMessage('System', `You joined "${currentRoomData.name}".`);
                
                document.querySelectorAll('.room-item.active').forEach(el => el.classList.remove('active'));
                const roomItemInList = Array.from(document.getElementById('roomList').children).find(child => child.textContent.includes(currentRoomData.name));
                if (roomItemInList) roomItemInList.classList.add('active');

                listenToRoomChanges();
            }).catch(error => {
                console.error("Error joining room (setting user):", error);
                alert("Failed to join room. Check Firebase rules and console. Error: " + error.message);
                currentRoomId = null; currentRoomData = null;
            });
        }
        
        function leaveCurrentRoom() {
            if (!currentRoomId || !firebaseUser) return;

            addChatMessage('System', `You left "${currentRoomTitleEl.textContent}".`);
            
            // Explicitly detach listeners if you stored their unsubscribe functions
            // e.g., if (usersListenerUnsubscribe) usersListenerUnsubscribe();

            const userPresenceRef = ref(db, `rooms/${currentRoomId}/users/${firebaseUser.uid}`);
            const disconnectHandler = onDisconnect(userPresenceRef);
            disconnectHandler.cancel(); 
            remove(userPresenceRef);

            currentRoomId = null;
            currentRoomData = null;
            currentRoomTitleEl.textContent = 'Canvas Area';
            document.getElementById('usersList').innerHTML = '';
            document.getElementById('chatMessages').innerHTML = ''; 
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            saveCanvasState(); 
            updateRoomsList({}); 
            if (firebaseUser) listenToPublicRooms(); 
        }

        function listenToRoomChanges() {
            if (!currentRoomId || !firebaseUser) return;

            const usersRefPath = `rooms/${currentRoomId}/users`;
            onValue(ref(db, usersRefPath), snapshot => {
                const users = snapshot.val() || {};
                updateUsersList(Object.values(users));
                // Refresh public room list for user count (could be optimized)
                onValue(ref(db, `rooms/${currentRoomId}/metadata/isPrivate`), (isPrivateSnap) => {
                    if (!isPrivateSnap.val()) {
                        if (firebaseUser) listenToPublicRooms(); 
                    }
                }, { onlyOnce: true });
            });

            const chatQuery = query(ref(db, `rooms/${currentRoomId}/chatMessages`), orderByChild('timestamp'), limitToLast(50));
            onValue(chatQuery, snapshot => { 
                document.getElementById('chatMessages').innerHTML = ''; 
                snapshot.forEach(childSnapshot => {
                    const msg = childSnapshot.val();
                    if (msg) addChatMessage(msg.username, msg.message, msg.userId === firebaseUser.uid);
                });
            });

            const canvasStateRefPath = `rooms/${currentRoomId}/fullCanvasDataUrl`;
            onValue(ref(db, canvasStateRefPath), snapshot => {
                const imageDataUrl = snapshot.val();
                if (imageDataUrl) {
                    loadRoomCanvas(imageDataUrl);
                }
            });
        }

        function updateUsersList(usersArray) {
            // ... (same as before)
            const usersListEl = document.getElementById('usersList');
            usersListEl.innerHTML = usersArray.map(user => 
                `<span class="user-item ${user === localUsername ? 'me' : ''}">${user}</span>` // 'me' class might need adjustment if username isn't unique guarantee
            ).join('');
        }

        function addChatMessage(author, message, isOwnMessage = false) {
            // ... (same as before)
             const chatMessagesEl = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            if (isOwnMessage) messageDiv.classList.add('own-message');
            if (author === 'System') {
                 messageDiv.style.fontStyle = 'italic';
                 messageDiv.style.color = 'rgba(255,255,255,0.7)';
            }
            const authorSpan = document.createElement('span');
            authorSpan.className = 'message-author';
            authorSpan.textContent = author === localUsername && isOwnMessage ? 'You' : author;
            const textSpan = document.createElement('span');
            textSpan.className = 'message-text';
            textSpan.textContent = message; 
            messageDiv.appendChild(authorSpan);
            messageDiv.appendChild(textSpan);
            chatMessagesEl.appendChild(messageDiv);
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        window.sendMessage = function() { 
            if (!firebaseUser) { alert("Authentication required to send messages."); return; }
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (message && currentRoomId && localUsername) {
                push(ref(db, `rooms/${currentRoomId}/chatMessages`), {
                    username: localUsername,
                    userId: firebaseUser.uid, // Use Firebase Auth UID
                    message: message,
                    timestamp: serverTimestamp()
                });
                input.value = '';
            } else if (!currentRoomId) {
                addChatMessage('System', 'You must be in a room to send messages.');
            } else if (!localUsername) {
                addChatMessage('System', 'Please set a username to send messages.');
            }
        }

        // --- Canvas Drawing Functions ---
        // (largely same, ensure firebaseUser check before operations if they write to DB)
        function getMousePos(e) { /* ... same ... */ 
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return [(clientX - rect.left) * scaleX, (clientY - rect.top) * scaleY];
        }

        function startDrawing(e) {
            if (!currentRoomId || !firebaseUser) return;
            // ... (rest of startDrawing is same) ...
            e.preventDefault(); 
            isDrawing = true;
            [lastX, lastY] = getMousePos(e);
            currentPath = []; 
            if (currentTool === 'fill') {
                performFloodFill(Math.floor(lastX), Math.floor(lastY)); 
                saveCanvasState(); 
                updateFirebaseCanvas(); 
                isDrawing = false; 
                return;
            }
            if (currentTool === 'brush' || currentTool === 'eraser') {
                const size = parseFloat(document.getElementById('brushSize').value);
                ctx.beginPath();
                ctx.arc(lastX, lastY, size / 2, 0, Math.PI * 2);
                ctx.fillStyle = currentTool === 'brush' ? document.getElementById('colorPicker').value : 'rgba(0,0,0,0)';
                if (currentTool === 'eraser') ctx.globalCompositeOperation = 'destination-out';
                else ctx.globalCompositeOperation = 'source-over';
                ctx.fill();
                ctx.globalCompositeOperation = 'source-over'; 
                currentPath.push({ x: lastX, y: lastY, tool: currentTool, color: ctx.fillStyle, size: size });
            }
        }

        function draw(e) {
            if (!isDrawing || !currentRoomId || !firebaseUser) return;
            // ... (rest of draw is same) ...
            e.preventDefault();
            const [currentX, currentY] = getMousePos(e);
            const color = document.getElementById('colorPicker').value;
            const size = parseFloat(document.getElementById('brushSize').value);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round'; 
            if (currentTool === 'brush') {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = color;
                ctx.lineWidth = size;
            } else if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out'; 
                ctx.lineWidth = size;
            } else return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            currentPath.push({ x: currentX, y: currentY, tool: currentTool, color: color, size: size });
            [lastX, lastY] = [currentX, currentY];
        }

        function stopDrawing(e) {
            if (!isDrawing && currentTool !== 'fill') return; 
            if (!currentRoomId || !firebaseUser) return;
            // ... (rest of stopDrawing is same) ...
            isDrawing = false;
            if (e) e.preventDefault();
            ctx.globalCompositeOperation = 'source-over';
            if (currentPath.length > 0 || currentTool === 'fill') { 
                saveCanvasState(); 
                updateFirebaseCanvas(); 
            }
            currentPath = []; 
        }
        
        function updateFirebaseCanvas() {
            if (!currentRoomId || !firebaseUser) return;
            const imageDataUrl = canvas.toDataURL();
            set(ref(db, `rooms/${currentRoomId}/fullCanvasDataUrl`), imageDataUrl)
                .catch(error => {
                    console.error("Error updating canvas state in Firebase:", error);
                    if (error.code === 'PERMISSION_DENIED') {
                        addChatMessage('System', 'Error: Canvas update denied. Check Firebase rules.');
                    }
                });
        }

        function performFloodFill(startX, startY) { /* ... same ... */ 
             const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const startPos = (startY * canvas.width + startX) * 4;
            const startR = data[startPos];
            const startG = data[startPos + 1];
            const startB = data[startPos + 2];
            const fillColorHex = document.getElementById('colorPicker').value;
            const fillColorRgb = hexToRgb(fillColorHex);
            if (!fillColorRgb) return; 
            const [fillR, fillG, fillB] = fillColorRgb;
            if (startR === fillR && startG === fillG && startB === fillB) return;
            const pixelStack = [[startX, startY]];
            while (pixelStack.length) {
                const [x, y] = pixelStack.pop();
                let currentPos = (y * canvas.width + x) * 4;
                if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
                if (data[currentPos] === fillR && data[currentPos+1] === fillG && data[currentPos+2] === fillB) continue;
                if (data[currentPos] !== startR || data[currentPos + 1] !== startG || data[currentPos + 2] !== startB) continue;
                data[currentPos] = fillR; data[currentPos + 1] = fillG; data[currentPos + 2] = fillB; data[currentPos + 3] = 255; 
                pixelStack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
            }
            ctx.putImageData(imageData, 0, 0);
        }
        function hexToRgb(hex) { /* ... same ... */ 
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : null;
        }

        window.handleImageUpload = function(e) { 
            if (!currentRoomId || !firebaseUser) { alert("Please join a room and be authenticated."); e.target.value = null; return; }
            // ... (rest of handleImageUpload is same) ...
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const hRatio = canvas.width / img.width, vRatio = canvas.height / img.height;
                    const ratio = Math.min(hRatio, vRatio, 1); 
                    const centerX = (canvas.width - img.width * ratio) / 2, centerY = (canvas.height - img.height * ratio) / 2;
                    ctx.drawImage(img, 0, 0, img.width, img.height, centerX, centerY, img.width * ratio, img.height * ratio);
                    saveCanvasState(); updateFirebaseCanvas();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file); e.target.value = null; 
        }

        function saveCanvasState() { /* ... same ... */ 
            if (undoStack.length >= 20) undoStack.shift(); 
            undoStack.push(canvas.toDataURL());
            redoStack = []; updateUndoRedoButtons();
        }
        window.undo = function() { 
            if (!firebaseUser) return;
            // ... (rest is same) ...
            if (undoStack.length > 1) { 
                redoStack.push(undoStack.pop());
                applyImageDataForUndoRedo(undoStack[undoStack.length - 1]);
            }
        }
        window.redo = function() { 
            if (!firebaseUser) return;
            // ... (rest is same) ...
            if (redoStack.length > 0) {
                const imageData = redoStack.pop();
                undoStack.push(imageData);
                applyImageDataForUndoRedo(imageData);
            }
        }
        function applyImageDataForUndoRedo(imageDataUrl) { /* ... same, calls updateFirebaseCanvas ... */ 
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                ctx.drawImage(img, 0, 0);
                if(firebaseUser && currentRoomId) updateFirebaseCanvas(); 
                updateUndoRedoButtons();
            };
            img.src = imageDataUrl;
        }
        function updateUndoRedoButtons(){ /* ... same ... */ 
            document.querySelector('.tool-btn[onclick="window.undo()"]').disabled = undoStack.length <= 1;
            document.querySelector('.tool-btn[onclick="window.redo()"]').disabled = redoStack.length === 0;
        }

        window.clearCanvas = function() { 
            if (!currentRoomId || !firebaseUser) return;
            // ... (rest is same) ...
            if (confirm("Clear canvas for everyone?")) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                saveCanvasState(); updateFirebaseCanvas();
            }
        }
        window.downloadCanvas = function() { /* ... same ... */ 
            const link = document.createElement('a');
            link.download = `canvas-${currentRoomData ? currentRoomData.name.replace(/\s+/g, '_') : 'drawing'}.png`;
            link.href = canvas.toDataURL('image/png'); link.click();
        }

        function loadRoomCanvas(canvasDataUrl) { /* ... same ... */ 
            if (canvasDataUrl) {
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0);
                    undoStack = [canvas.toDataURL()]; redoStack = [];
                    updateUndoRedoButtons();
                };
                img.src = canvasDataUrl;
            } else { ctx.clearRect(0, 0, canvas.width, canvas.height); saveCanvasState(); }
        }

        // --- UI & Mobile Functions (mostly same) ---
        function setupMobileSupport() { /* ... same ... */ 
            const isMobile = window.innerWidth <= 768;
            mainMobileMenuBtnEl.style.display = isMobile ? 'flex' : 'none';
            sidebarMobileMenuBtnEl.style.display = isMobile ? 'flex' : 'none';
            if (!isMobile) { sidebarEl.classList.remove('open'); appContainerEl.classList.remove('sidebar-open'); }
            if (isMobile && sidebarEl.classList.contains('open')) { toggleSidebar(); }
        }
        window.addEventListener('resize', setupMobileSupport);

        window.toggleSidebar = function() { /* ... same ... */ 
            sidebarEl.classList.toggle('open'); appContainerEl.classList.toggle('sidebar-open');
            const sidebarIcon = sidebarMobileMenuBtnEl.querySelector('i');
            sidebarIcon.setAttribute('data-lucide', sidebarEl.classList.contains('open') ? 'x' : 'menu');
            lucide.createIcons(); 
        }
        window.closeModal = function() { /* ... same ... */ 
            document.getElementById('joinModal').classList.add('hidden');
            joinRoomPasswordInputEl.value = '';
        }
        
        function setupCanvasEvents() { /* ... (same as previous version, ensure onclicks call window.funcName) ... */ 
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing); 

            canvas.addEventListener('touchstart', (e) => { 
                if (!firebaseUser) return;
                const touch = e.touches[0] || e.changedTouches[0];
                const mockEvent = new MouseEvent('mousedown', { clientX: touch.clientX, clientY: touch.clientY });
                startDrawing(mockEvent);
            }, { passive: false });
            canvas.addEventListener('touchmove', (e) => { 
                if (!firebaseUser) return;
                e.preventDefault(); 
                const touch = e.touches[0] || e.changedTouches[0];
                const mockEvent = new MouseEvent('mousemove', { clientX: touch.clientX, clientY: touch.clientY });
                draw(mockEvent);
            }, { passive: false });
            canvas.addEventListener('touchend', (e) => { 
                if (!firebaseUser) return;
                const touch = e.changedTouches[0]; 
                const mockEvent = new MouseEvent('mouseup', { clientX: touch.clientX, clientY: touch.clientY });
                stopDrawing(mockEvent);
            }, { passive: false });
        }
    </script>
    <!-- ... (rest of the body) ... -->
